{% extends 'main/base_projects.html' %}

{% load static %}

{% block content %}

    {% block extracss %}
    <link type='text/css' rel="stylesheet" href="{% static 'viewmodel/css/fire_prog.css' %}"/>
    {% endblock %}


    <form id="georreferencingForm" action="./progression" method="POST">
    {% if image is not None %}
        <div hidden>
            {{ georreferencing.marker }}
            {{ georreferencing.eraser }}
            {{ georreferencing.pixels }}
            {{ georreferencing.geo }}
            {{ georreferencing.frame_id }}
        </div>
        {% csrf_token %}
        <div id="img_prog"  style="display: flex; padding-top: 20vh; justify-content: center; align-items: center; ">
        {% if georreferenced %}
            <img draggable="false" id="workingImage" src={{ georreferenced }}>
            <img hidden draggable="false" id="hiddenWorkingImage" src={{ frame.content.url }}>
        {% else %}
            <img draggable="false" id="workingImage" src={{ frame.content.url }}>
        {% endif %}
        </div>
    {% endif %}
    </form>

	<div class="toolkit">
		<table>
			<caption id="caption">Toolkit<a id= "cp" title="Close Toolkit" onclick="openCloseToolkit()"><i id="close" class="fas fa-times"></i></a></caption>
			<tbody id="toolkit">
			<tr>
				<td><i class="fas fa-image fa-lg"></i></td>
				<td><i class="fas fa-search-plus fa-lg"></i></td>
			</tr>
			<tr>
				<td id="marker" {% if georreferencing.marker.value == True %} style="color: #B55B29" {% endif %} onclick="markerOn()"><i class="fas fa-map-marker-alt fa-lg"></i></td>
				<td><i class="fas fa-search-minus fa-lg"></i></td>
			</tr>
			<tr>
				<td><i class="fas fa-play fa-lg"></i></td>
				<td onclick="saveCoords()"><i class="fas fa-save fa-lg" aria-hidden="true"></i></td>
			</tr>
			<tr>
				<td><i class="fas fa-layer-group fa-lg" aria-hidden="true"></i></td>
				<td><a onclick="openUpload()"><i class="fa fa-folder-open fa-lg" aria-hidden="true"></i></td>
			</tr>
			<tr>
				<td><i class="fas fa-expand-arrows-alt fa-lg" aria-hidden="true"></i></td>
				<td><i class="fa fa-question-circle fa-lg" aria-hidden="true"></i></td>
			</tr>
		</tbody>
		</table>
	</div>

	<div class="upload" id="upload">
		<h1>Upload Files</h1>
		<p>If you have the polygon coordinates, or the file that contains them, please use this tool in order to see how the fire evolved:</p>
		<input type="text" name="polygon-coord" id="polygon-coord" value="" placeholder="List with polygon coordinates" >
		<form style="overflow: hidden; padding: 0.1em 0 0 1em;" method="POST" action="{% url 'upload' project.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                {{ file_form.coords }}
                <button type="button" id="file-upload__button" class="button icon solid fa-download">Choose File</button>
                <span class="file-upload__label"></span>
                <input type="submit" value="Upload image">
			</form>
        <button class="button icon solid" type="button" value="Draw" name="drawPolygonButton" id="drawPolygonButton" onclick="drawMap()">DRAW </button><br>
	</div>
    <br>

	<!-- TODO see the best way to view the progression-->
	<div id="map" style="height: 600px;">

    </div>


    <div id="popUpGEO">
        <small>Geographic Coordinates: lat, lon</small>
        <br>
        <input id='coordinates' type='text' name='coordinates' class='form-control'>
        <br>
        <button class='btn btn-default'id='submit'> SAVE! </button>
    </div>

    <img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/678111-map-marker-512.png" id="marker" style="display: none; position: absolute; width: 50px; height: 50px;" />

    {% block extrajs %}
        <!-- This is necessary for the popUp -->
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <!--
            <script src="{% static 'viewmodel/js/map.js' %}"></script>
        -->
    <script src="{% static 'viewmodel/js/fire_prog.js' %}"></script>

    <!-- TODO: Move this script into viewmodel once it's finished -->
    <script>

        $(function() {
            console.log('YEEEET');

            let popUp = $('#popUpGEO')
            let input = $('#coordinates')
            let workingImage = $('#workingImage');
            let pixels = []
            let geocoords = []
            let marker = $('#marker')

            popUp.dialog({
                autoOpen: false,
                show: {
                    effect: "blind",
                    duration: 300
                },
                draggable: true,
                hide: "blind",
                resizable: false,
                height: "auto",
                width: 300,
                modal: true,
            });


            workingImage.mousedown(function (event) {

                clicking = true
                let x = event.pageX - this.offsetLeft;
                let y = event.pageY - this.offsetTop;
                pixels.push([x, y])
                console.log("ARRAY PIXELS COORDS", pixels)

                // Move circle here.
                marker.css('top', event.pageY - 50);
                marker.css('left', event.pageX - 25);
                if (marker.css('display') == 'none') {
                    marker.css('display', 'block');
                }


                var pos = {my: "left top", at: "left bottom", of: event}
                // console.log("POS: ", pos)
                input.val('')
                popUp.dialog("option", "position", pos)
                    .dialog("open");

            });

            $('#submit').click(function () {
                coords = input.val()
                // console.log(coords)
                var coords = input.val().split(", ")
                // console.log(coords)
                geocoords.push([coords[0], coords[1]])
                console.log("ARRAY GEO COORDS", geocoords);
                marker.css('display', 'none')
                popUp.dialog("close");

            });

            function markerOn() {
                $("#id_marker").attr('checked', true);
                $("#id_eraser").attr('checked', false);
                $("#marker").css("color", "#B55B29")
                $("#eraser").css("color", "")
            }

            function markerOff() {
                $("#id_marker").attr('checked', false);
                $("#id_eraser").attr('checked', true);
                $("#marker").css("color", "")
                $("#eraser").css("color", "#B55B29")
            }

            function saveCoords() {
                clicking = false;
                $('#id_pixels').val(JSON.stringify(pixels));
                $('#id_geo').val(JSON.stringify(geocoords));
                document.getElementById("georreferencingForm").submit();
            }

        });

    </script>
    {% endblock %}



{% endblock %}